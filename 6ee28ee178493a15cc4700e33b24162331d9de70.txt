#!/usr/bin/env python3

import sys
import os
import json
from pathlib import Path
from PIL import Image
import colorsys

VERSION = "0.3"

ROOT = Path(__file__).parent.resolve()
PALETTES_DIR = ROOT / "palettes"


# ----------------------------
# Utility
# ----------------------------

def die(msg: str) -> None:
    print(f"Error: {msg}")
    sys.exit(1)


def banner() -> None:
    print(
"""█████▄ ██ ██  ██ ██████ ██       ▄▄▄▄  ▄▄ ▄▄
██▄▄█▀ ██  ████  ██▄▄   ██       ██▄█▀ ▀███▀
██     ██ ██  ██ ██▄▄▄▄ ██████ ▄ ██      █
pixel.py
"""
    )


def supports_color() -> bool:
    if os.environ.get("NO_COLOR", ""):
        return False
    try:
        return sys.stdout.isatty()
    except Exception:
        return False


def hex_to_rgb(hex_color: str):
    s = hex_color.strip().lstrip("#")
    if len(s) != 6:
        die(f"Invalid hex color: {hex_color}")
    return tuple(int(s[i:i+2], 16) for i in (0, 2, 4))


def rgb_to_hsv_deg(rgb):
    r, g, b = rgb
    rf, gf, bf = (r / 255.0, g / 255.0, b / 255.0)
    h, s, v = colorsys.rgb_to_hsv(rf, gf, bf)
    return int(h * 360) % 360, int(s * 100), int(v * 100)


def ansi_bg(rgb, text="  "):
    r, g, b = rgb
    return f"\x1b[48;2;{r};{g};{b}m{text}\x1b[0m"


def ansi_fg(rgb, text):
    r, g, b = rgb
    return f"\x1b[38;2;{r};{g};{b}m{text}\x1b[0m"


# ----------------------------
# Palette handling
# ----------------------------

def load_palettes():
    palettes = {}
    if not PALETTES_DIR.exists():
        return palettes

    for path in PALETTES_DIR.rglob("*.json"):
        try:
            with open(path, "r", encoding="utf-8") as f:
                data = json.load(f)

            name = data.get("name") or path.stem
            system = data.get("system")
            colors = []
            for c in data.get("colors", []):
                if isinstance(c, dict) and "hex" in c:
                    colors.append({"hex": c["hex"], "name": c.get("name")})

            if colors:
                palettes[name] = {
                    "name": name,
                    "system": system,
                    "path": str(path),
                    "colors": colors,
                }
        except Exception:
            pass
    return palettes


PALETTES = load_palettes()


def list_palettes():
    if not PALETTES:
        print("No palettes found.")
        return
    for name, meta in sorted(PALETTES.items()):
        print(f"{name:20} {len(meta['colors'])} colors")


def check_palette(name: str):
    if name not in PALETTES:
        die(f"Unknown palette: {name}")

    meta = PALETTES[name]
    colors = meta["colors"]
    use_color = supports_color()

    print(f"Palette: {name}  ({meta.get('system')}, {len(colors)} colors)")
    print(f"Source:  {meta.get('path')}")

    print("\n  swatch        hex       rgb                hsv")
    print("  -----         ---       ---                ---")

    for c in colors:
        rgb = hex_to_rgb(c["hex"])
        h, s, v = rgb_to_hsv_deg(rgb)
        if use_color:
            sw = ansi_bg(rgb) + ansi_bg(rgb)
            hx = ansi_fg(rgb, c["hex"])
        else:
            sw = ""
            hx = c["hex"]

        print(f"  {sw:12} {hx:9} rgb({rgb[0]:3},{rgb[1]:3},{rgb[2]:3})   hsv({h:3}°, {s:3}%, {v:3}%)")


def get_palette(name, max_colors=None):
    if not name or name == "auto":
        return None
    if name not in PALETTES:
        die(f"Unknown palette: {name}")
    cols = [c["hex"] for c in PALETTES[name]["colors"]]
    return cols[:max_colors] if max_colors else cols


# ----------------------------
# Geometry (shared)
# ----------------------------

def snap_to_grid(img: Image.Image, px: int) -> Image.Image:
    if px <= 1:
        return img
    w, h = img.size
    w2 = max(1, w // px)
    h2 = max(1, h // px)
    small = img.resize((w2, h2), Image.NEAREST)
    return small.resize((w2 * px, h2 * px), Image.NEAREST)


# ----------------------------
# Color processing
# ----------------------------

def quantize_to_palette(img, palette_hex):
    palette_rgb = []
    for h in palette_hex:
        palette_rgb.extend(hex_to_rgb(h))

    pal_img = Image.new("P", (1, 1))
    pal_img.putpalette(palette_rgb * (256 // len(palette_hex)))

    return img.convert("RGB").quantize(
        palette=pal_img, dither=Image.NONE
    ).convert("RGBA")


# ----------------------------
# Commands
# ----------------------------

def cmd_help():
    banner()
    print(
f"""Usage:
  pixel help
  pixel palette
  pixel check <palette>
  pixel run <input> <output> [options]
  pixel resize <input> <output> [options]

Options:
  --px <n>            Pixel size (grid) (default: 1)

Options for run only:
  --palette <name>    Palette name
  --colors <n>        Limit palette colors

Env:
  NO_COLOR=1          Disable ANSI color output

Version:
  {VERSION}
"""
    )


def cmd_run(args):
    if len(args) < 2:
        die("run requires <input> <output>")

    inp, out = Path(args[0]), Path(args[1])
    palette = None
    colors = None
    px = 1

    i = 2
    while i < len(args):
        if args[i] == "--palette":
            palette = args[i + 1]
            i += 2
        elif args[i] == "--colors":
            colors = int(args[i + 1])
            i += 2
        elif args[i] == "--px":
            px = int(args[i + 1])
            i += 2
        else:
            die(f"Unknown option: {args[i]}")

    if not inp.exists():
        die(f"Input not found: {inp}")

    img = Image.open(inp).convert("RGBA")
    img = snap_to_grid(img, px)

    pal = get_palette(palette, colors)
    if pal:
        img = quantize_to_palette(img, pal)

    out.parent.mkdir(parents=True, exist_ok=True)
    img.save(out)
    print(f"Wrote {out}")


def cmd_resize(args):
    if len(args) < 2:
        die("resize requires <input> <output>")

    inp, out = Path(args[0]), Path(args[1])
    px = 1

    i = 2
    while i < len(args):
        if args[i] == "--px":
            px = int(args[i + 1])
            i += 2
        else:
            die(f"Unknown option: {args[i]}")

    if not inp.exists():
        die(f"Input not found: {inp}")

    img = Image.open(inp).convert("RGBA")
    img = snap_to_grid(img, px)

    out.parent.mkdir(parents=True, exist_ok=True)
    img.save(out)
    print(f"Wrote {out}")


# ----------------------------
# Main
# ----------------------------

def main():
    if len(sys.argv) < 2:
        cmd_help()
        return

    cmd, args = sys.argv[1], sys.argv[2:]

    if cmd == "help":
        cmd_help()
    elif cmd == "palette":
        list_palettes()
    elif cmd == "check":
        if not args:
            die("check requires <palette>")
        check_palette(args[0])
    elif cmd == "run":
        cmd_run(args)
    elif cmd == "resize":
        cmd_resize(args)
    else:
        banner()
        die(f"Unknown command: {cmd}")


if __name__ == "__main__":
    main()